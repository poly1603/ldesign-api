{"version":3,"file":"rate-limit.js","sources":["../../../../../http/es/utils/rate-limit.js"],"sourcesContent":["class t{constructor(t={}){this.requests=[],this.config={maxRequests:t.maxRequests??100,timeWindow:t.timeWindow??6e4,allowBurst:t.allowBurst??!1,burstSize:t.burstSize??10},this.burstTokens=this.config.burstSize}canMakeRequest(){const t=Date.now();return this.requests=this.requests.filter(e=>t-e<this.config.timeWindow),!!(this.requests.length<this.config.maxRequests||this.config.allowBurst&&this.burstTokens>0)}recordRequest(){const t=Date.now();this.requests=this.requests.filter(e=>t-e<this.config.timeWindow),this.requests.length>=this.config.maxRequests&&this.config.allowBurst&&this.burstTokens>0&&this.burstTokens--,this.requests.push(t),this.scheduleBurstTokenRestore()}scheduleBurstTokenRestore(){this.config.allowBurst&&this.burstTokens<this.config.burstSize&&setTimeout(()=>{this.burstTokens=Math.min(this.burstTokens+1,this.config.burstSize)},1e3)}getNextAvailableTime(){return this.canMakeRequest()||0===this.requests.length?0:Math.min(...this.requests)+this.config.timeWindow-Date.now()}async waitForAvailability(){const t=this.getNextAvailableTime();t>0&&await new Promise(e=>setTimeout(e,t))}async waitWithBackoff(t=0){const e=this.getNextAvailableTime();if(e<=0)return;const s=Math.min(e*2**t,3e4);await new Promise(t=>setTimeout(t,s))}reset(){this.requests=[],this.burstTokens=this.config.burstSize}getStatus(){const t=Date.now();return this.requests=this.requests.filter(e=>t-e<this.config.timeWindow),{currentRequests:this.requests.length,maxRequests:this.config.maxRequests,timeWindow:this.config.timeWindow,nextAvailableTime:this.getNextAvailableTime(),isLimited:!this.canMakeRequest()}}updateConfig(t){Object.assign(this.config,t),void 0!==t.burstSize&&(this.burstTokens=Math.min(this.burstTokens,t.burstSize))}getRequestHistory(){const t=Date.now();return this.requests.filter(e=>t-e<this.config.timeWindow)}getCurrentRate(){const t=Date.now();return this.requests.filter(e=>t-e<1e3).length}predictAvailabilityForBatch(t){const e=this.requests.length,s=this.config.maxRequests-e;if(s>=t)return 0;const i=t-s;return i>this.requests.length?this.config.timeWindow:[...this.requests].sort()[i-1]+this.config.timeWindow-Date.now()}}function e(e){return new t(e)}function s(e){const s=new t(e);return function(t){return async(...e)=>(await s.waitForAvailability(),s.recordRequest(),t(...e))}}const i=new t;export{t as RateLimitManager,e as createRateLimitManager,i as globalRateLimitManager,s as rateLimit};\n//# sourceMappingURL=rate-limit.js.map\n"],"names":["t","e","s","i"],"mappings":"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"}