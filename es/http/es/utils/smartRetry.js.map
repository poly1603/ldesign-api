{"version":3,"file":"smartRetry.js","sources":["../../../../../http/es/utils/smartRetry.js"],"sourcesContent":["var e,t;(t=e||(e={})).IMMEDIATE=\"immediate\",t.EXPONENTIAL=\"exponential\",t.LINEAR=\"linear\",t.FIXED=\"fixed\",t.NONE=\"none\";class a{constructor(e={}){this.config={maxRetries:e.maxRetries??3,baseDelay:e.baseDelay??1e3,maxDelay:e.maxDelay??3e4,checkNetworkStatus:e.checkNetworkStatus??!0,retryableStatusCodes:e.retryableStatusCodes??a.DEFAULT_RETRYABLE_STATUS_CODES,nonRetryableStatusCodes:e.nonRetryableStatusCodes??a.DEFAULT_NON_RETRYABLE_STATUS_CODES,customDecision:e.customDecision}}shouldRetry(t,a){if(a>=this.config?.maxRetries)return{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`已达到最大重试次数 ${this.config?.maxRetries}`};if(this.config?.customDecision){const e=this.config?.customDecision(t,a);if(e)return e}if(this.config?.checkNetworkStatus&&this.isOffline())return{shouldRetry:!1,delay:0,strategy:e.NONE,reason:\"当前网络离线\"};const s=t.response?.status;return s?this.config?.nonRetryableStatusCodes.includes(s)?{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`状态码 ${s} 不可重试（客户端错误）`}:this.config?.retryableStatusCodes.includes(s)?this.createRetryDecision(!0,a,this.getStrategyForStatusCode(s),`状态码 ${s} 可重试`):s>=500&&s<600?this.createRetryDecision(!0,a,e.EXPONENTIAL,`服务器错误 ${s}，使用指数退避重试`):{shouldRetry:!1,delay:0,strategy:e.NONE,reason:`状态码 ${s} 不在重试范围内`}:this.createRetryDecision(!0,a,e.EXPONENTIAL,\"网络错误，使用指数退避重试\")}createRetryDecision(e,t,a,s){return{shouldRetry:e,delay:this.calculateDelay(t,a),strategy:a,reason:s}}getStrategyForStatusCode(t){switch(t){case 429:default:return e.EXPONENTIAL;case 503:return e.LINEAR;case 504:return e.FIXED}}calculateDelay(t,a){let s;switch(a){case e.IMMEDIATE:s=0;break;case e.EXPONENTIAL:s=this.config?.baseDelay*2**t;break;case e.LINEAR:s=this.config?.baseDelay*t;break;case e.FIXED:s=this.config?.baseDelay;break;default:s=0}return s=this.addJitter(s),Math.min(s,this.config?.maxDelay)}addJitter(e){const t=.25*e;return e+(Math.random()*t*2-t)}isOffline(){return typeof navigator<\"u\"&&\"onLine\"in navigator&&!navigator.onLine}getRetryAdvice(e){const t=e.response?.status;return t?429===t?\"请求过于频繁，请稍后再试\":t>=500?\"服务器暂时不可用，请稍后重试\":t>=400&&t<500?\"请求参数有误，请检查后重试\":\"请求失败，请重试\":\"网络连接失败，请检查网络设置后重试\"}}function s(e){return new a(e)}a.DEFAULT_RETRYABLE_STATUS_CODES=[408,429,500,502,503,504],a.DEFAULT_NON_RETRYABLE_STATUS_CODES=[400,401,403,404,405,422];const r=new a;function n(e){const t=new a(e),s=new Map;return{onRejected:async e=>{const a=`${e.config?.method}:${e.config?.url}`,r=s.get(a)??0,n=t.shouldRetry(e,r);throw n.shouldRetry?(s.set(a,r+1),await new Promise(e=>setTimeout(e,n.delay)),e):(s.delete(a),e)}}}export{e as RetryStrategy,a as SmartRetryManager,n as createSmartRetryInterceptor,s as createSmartRetryManager,r as globalSmartRetryManager};\n//# sourceMappingURL=smartRetry.js.map\n"],"names":["e","t","a","s"],"mappings":"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"}