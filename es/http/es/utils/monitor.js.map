{"version":3,"file":"monitor.js","sources":["../../../../../http/es/utils/monitor.js"],"sourcesContent":["class t{constructor(t={}){this.metrics=[],this.metricsIndex=0,this.requestMap=new Map,this.statsCacheTime=0,this.statsCacheTTL=1e3,this.sampleCounter=0,this.config={enabled:!0,maxMetrics:1e3,slowRequestThreshold:3e3,samplingRate:1,enableSampling:!1,onSlowRequest:()=>{},onError:()=>{},onMetricsUpdate:()=>{},...t}}shouldSample(){return!this.config?.enableSampling||(this.sampleCounter++,Math.random()<this.config?.samplingRate)}startRequest(t,e){!this.config?.enabled||!this.shouldSample()||this.requestMap.set(t,{startTime:Date.now(),retries:0})}endRequest(t,e,s,i){if(!this.config?.enabled)return;const r=this.requestMap.get(t);if(!r)return;const a=Date.now(),n=a-r.startTime,o={requestId:t,url:e.url||\"\",method:e.method||\"GET\",startTime:r.startTime,endTime:a,duration:n,status:s?.status,size:this.getResponseSize(s),cached:!1,retries:r.retries,error:i,timestamp:a};this.addMetrics(o),this.requestMap.delete(t),this.invalidateStatsCache(),n>this.config?.slowRequestThreshold&&this.config?.onSlowRequest(o),i&&this.config?.onError(o),this.config?.onMetricsUpdate(this.metrics)}recordRetry(t){const e=this.requestMap.get(t);e&&e.retries++}markCached(t){const e=this.metrics.find(e=>e.requestId===t);e&&(e.cached=!0)}addMetrics(t){this.metrics.length<this.config?.maxMetrics?this.metrics.push(t):(this.metrics[this.metricsIndex]=t,this.metricsIndex=(this.metricsIndex+1)%this.config?.maxMetrics)}getResponseSize(t){return t?.data?t.data instanceof Blob?t.data.size:\"string\"==typeof t.data?new Blob([t.data]).size:\"object\"==typeof t.data?new Blob([JSON.stringify(t.data)]).size:0:0}getStats(){const t=Date.now();if(this.statsCache&&t-this.statsCacheTime<this.statsCacheTTL)return{...this.statsCache};const e=this.calculateStats();return this.statsCache=e,this.statsCacheTime=t,{...e}}calculateStats(){const t=this.metrics.length;if(0===t)return{totalRequests:0,successfulRequests:0,failedRequests:0,cachedRequests:0,averageDuration:0,averageResponseTime:0,medianDuration:0,p95Duration:0,p99Duration:0,slowRequests:0,totalDataTransferred:0,requestsByMethod:{},requestsByStatus:{},errorRate:0,cacheHitRate:0};let e=0,s=0,i=0,r=0,a=0,n=0;const o=Object.create(null),c=Object.create(null),h=Array.from({length:t},()=>0),u=this.config?.slowRequestThreshold;let l=0;for(const t of this.metrics){const d=t.duration;h[l++]=d,a+=d,n+=t.size||0,s+=t.error?1:0,e+=t.error?0:1,i+=t.cached?1:0,r+=d>u?1:0,o[t.method]=(o[t.method]||0)+1,t.status&&(c[t.status]=(c[t.status]||0)+1)}return t<100?this.insertionSort(h):h.sort((t,e)=>t-e),{totalRequests:t,successfulRequests:e,failedRequests:s,cachedRequests:i,averageDuration:a/t,averageResponseTime:a/t,medianDuration:this.getPercentile(h,50),p95Duration:this.getPercentile(h,95),p99Duration:this.getPercentile(h,99),slowRequests:r,totalDataTransferred:n,requestsByMethod:o,requestsByStatus:c,errorRate:s/t,cacheHitRate:i/t}}insertionSort(t){for(let e=1;e<t.length;e++){const s=t[e];let i=e-1;for(;i>=0&&t[i]>s;)t[i+1]=t[i],i--;t[i+1]=s}}invalidateStatsCache(){this.statsCache=void 0}getPercentile(t,e){if(0===t.length)return 0;const s=Math.ceil(e/100*t.length)-1;return t[Math.max(0,s)]}getRecentMetrics(t=10){return this.metrics.slice(-t)}getSlowRequests(){return this.metrics.filter(t=>t.duration>this.config?.slowRequestThreshold)}getFailedRequests(){return this.metrics.filter(t=>t.error)}clear(){this.metrics=[],this.requestMap.clear()}exportMetrics(){return[...this.metrics]}enable(){this.config&&(this.config.enabled=!0)}disable(){this.config&&(this.config.enabled=!1)}setSlowRequestThreshold(t){this.config&&(this.config.slowRequestThreshold=t)}getMetrics(){return[...this.metrics]}isEnabled(){return this.config?.enabled}}function e(e){return new t(e)}const s=e();export{t as RequestMonitor,e as createRequestMonitor,s as defaultMonitor};\n//# sourceMappingURL=monitor.js.map\n"],"names":["t","e","s"],"mappings":"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"}