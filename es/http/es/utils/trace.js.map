{"version":3,"file":"trace.js","sources":["../../../../../http/es/utils/trace.js"],"sourcesContent":["import{generateId as t}from\"./index.js\";var e,a,s;(a=e||(e={})).HTTP=\"http\",a.DATABASE=\"database\",a.CACHE=\"cache\",a.CUSTOM=\"custom\",function(t){t.PENDING=\"pending\",t.SUCCESS=\"success\",t.ERROR=\"error\",t.CANCELLED=\"cancelled\"}(s||(s={}));class r{constructor(t={}){this.traces=new Map,this.config={enabled:t.enabled??!0,sampleRate:t.sampleRate??1,propagateTraceId:t.propagateTraceId??!0,traceIdHeader:t.traceIdHeader??\"X-Trace-Id\",spanIdHeader:t.spanIdHeader??\"X-Span-Id\",exporter:t.exporter}}startTrace(t,a=e.HTTP){if(!this.shouldSample())return new c;const r=this.generateTraceId(),o={spanId:this.generateSpanId(),traceId:r,name:t,type:a,startTime:Date.now(),status:s.PENDING,tags:[],logs:[]},d={traceId:r,currentSpan:o,spans:[o],metadata:{}};return this.traces.set(r,d),new n(this,d,o)}getTrace(t){return this.traces.get(t)}finishTrace(t){const e=this.traces.get(t);if(e){if(this.config?.exporter){const t=this.config?.exporter(e.spans);t instanceof Promise&&t.catch(t=>{})}this.traces.delete(t)}}shouldSample(){return!!this.config?.enabled&&Math.random()<this.config?.sampleRate}generateTraceId(){return`trace-${t()}-${Date.now()}`}generateSpanId(){return`span-${t()}`}getConfig(){return this.config}}class n{constructor(t,e,a){this.tracer=t,this.context=e,this.rootSpan=a}get traceId(){return this.context.traceId}get spanId(){return this.rootSpan.spanId}startSpan(a,r=e.CUSTOM){const n={spanId:`span-${t()}`,parentSpanId:this.context.currentSpan?.spanId,traceId:this.context.traceId,name:a,type:r,startTime:Date.now(),status:s.PENDING,tags:[],logs:[]};return this.context.spans.push(n),this.context.currentSpan=n,new o(n)}addTag(t,e){return this.rootSpan.tags.push({key:t,value:e}),this}addLog(t,e){return this.rootSpan.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.rootSpan.status=s.ERROR,this.rootSpan.error={message:t.message,stack:t.stack},this}finish(t=s.SUCCESS){const e=Date.now();this.rootSpan.endTime=e,this.rootSpan.duration=e-this.rootSpan.startTime,this.rootSpan.status=t,this.tracer.finishTrace(this.context.traceId)}getSpans(){return[...this.context.spans]}getMetadata(){return this.context.metadata}setMetadata(t,e){return this.context.metadata[t]=e,this}}class o{constructor(t){this.span=t}addTag(t,e){return this.span.tags.push({key:t,value:e}),this}addLog(t,e){return this.span.logs.push({timestamp:Date.now(),message:t,data:e}),this}setError(t){return this.span.status=s.ERROR,this.span.error={message:t.message,stack:t.stack},this}finish(t=s.SUCCESS){const e=Date.now();this.span.endTime=e,this.span.duration=e-this.span.startTime,this.span.status=t}getRawSpan(){return this.span}}class c extends n{constructor(){super(null,null,null)}startSpan(){return new d}addTag(){return this}addLog(){return this}setError(){return this}finish(){}getSpans(){return[]}}class d extends o{constructor(){super(null)}addTag(){return this}addLog(){return this}setError(){return this}finish(){}}function i(t){return new r(t)}const p=new r;function h(t){const a=new r(t),n=new Map;return{request:{onFulfilled:t=>{const s=a.startTrace(`${t.method?.toUpperCase()} ${t.url}`,e.HTTP);s.addTag(\"http.method\",t.method||\"GET\"),s.addTag(\"http.url\",t.url||\"\"),t.baseURL&&s.addTag(\"http.base_url\",t.baseURL),t.__trace__=s;const r=a.getConfig();return r.propagateTraceId&&(t.headers=t.headers||{},r.traceIdHeader&&r.spanIdHeader&&(t.headers[r.traceIdHeader]=s.traceId,t.headers[r.spanIdHeader]=s.spanId)),n.set(s.traceId,s),t}},response:{onFulfilled:t=>{const e=t.config.__trace__;return e&&(e.addTag(\"http.status\",t.status),e.addLog(\"Response received\"),e.finish(s.SUCCESS),n.delete(e.traceId)),t},onRejected:t=>{const e=t.config.__trace__;throw e&&(t.response&&e.addTag(\"http.status\",t.response.status),e.setError(t),e.addLog(\"Request failed\",{error:t.message}),e.finish(s.ERROR),n.delete(e.traceId)),t}}}}function u(t){t.forEach(t=>{t.duration&&t.duration,t.status===s.SUCCESS||(t.status,s.ERROR);t.tags.length,t.logs.length,t.error})}export{r as RequestTracer,o as Span,s as SpanStatus,e as SpanType,n as Trace,u as consoleExporter,i as createRequestTracer,h as createTraceInterceptor,p as globalTracer};\n//# sourceMappingURL=trace.js.map\n"],"names":["t","a","r","o","d","e","n"],"mappings":"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"}