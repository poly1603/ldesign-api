{"version":3,"file":"dedup-manager.js","sources":["../../../../../http/es/utils/dedup-manager.js"],"sourcesContent":["class e{constructor(e={}){this.pendingRequests=new Map,this.stats={executions:0,duplications:0,savedRequests:0},this.config={maxPendingRequests:e.maxPendingRequests??1e3,cleanupInterval:e.cleanupInterval??3e4,requestTimeout:e.requestTimeout??6e4,autoCleanup:e.autoCleanup??!0},this.config.autoCleanup&&this.startAutoCleanup()}async execute(e,t){if(this.pendingRequests.has(e)){const t=this.pendingRequests.get(e);return t.refCount++,this.stats.duplications++,this.stats.savedRequests++,t.promise}this.pendingRequests.size>=this.config.maxPendingRequests&&this.cleanupOldestRequest();const s=t().finally(()=>{this.pendingRequests.delete(e)}),n={promise:s,createdAt:Date.now(),refCount:1,key:e};return this.pendingRequests.set(e,n),this.stats.executions++,s}startAutoCleanup(){this.cleanupTimer=setInterval(()=>{this.cleanupTimeoutTasks(this.config.requestTimeout)},this.config.cleanupInterval)}stopAutoCleanup(){this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0)}cleanupOldestRequest(){let e=null,t=Number.POSITIVE_INFINITY;for(const[s,n]of this.pendingRequests)n.createdAt<t&&(t=n.createdAt,e=s);e&&this.pendingRequests.delete(e)}cleanupTimeoutTasks(e){const t=Date.now();let s=0;for(const[n,i]of this.pendingRequests)t-i.createdAt>e&&(this.pendingRequests.delete(n),s++);return s}cancel(e){return this.pendingRequests.delete(e)}cancelAll(){this.pendingRequests.clear()}isRunning(e){return this.pendingRequests.has(e)}async waitFor(e){const t=this.pendingRequests.get(e);if(!t)return null;try{return await t.promise}catch{return null}}async waitForAll(){const e=Array.from(this.pendingRequests.values()).map(e=>e.promise.catch(()=>{}));await Promise.all(e)}getTaskInfo(e){const t=this.pendingRequests.get(e);return t?{key:t.key,createdAt:t.createdAt,refCount:t.refCount,duration:Date.now()-t.createdAt}:null}getAllTaskInfo(){return Array.from(this.pendingRequests.values()).map(e=>({key:e.key,createdAt:e.createdAt,refCount:e.refCount,duration:Date.now()-e.createdAt}))}getStats(){const e=this.stats.executions+this.stats.duplications;return{executions:this.stats.executions,duplications:this.stats.duplications,savedRequests:this.stats.savedRequests,deduplicationRate:e>0?this.stats.duplications/e:0,pendingCount:this.pendingRequests.size}}resetStats(){this.stats={executions:0,duplications:0,savedRequests:0}}getPendingCount(){return this.pendingRequests.size}getPendingKeys(){return Array.from(this.pendingRequests.keys())}getMostReferencedTask(){let e=0,t=\"\";for(const[s,n]of this.pendingRequests)n.refCount>e&&(e=n.refCount,t=s);return e>0?{key:t,refCount:e}:null}getLongestRunningTask(){let e=0,t=\"\";const s=Date.now();for(const[n,i]of this.pendingRequests){const a=s-i.createdAt;a>e&&(e=a,t=n)}return e>0?{key:t,duration:e}:null}updateConfig(e){Object.assign(this.config,e),void 0!==e.autoCleanup&&(e.autoCleanup&&!this.cleanupTimer?this.startAutoCleanup():!e.autoCleanup&&this.cleanupTimer&&this.stopAutoCleanup())}destroy(){this.stopAutoCleanup(),this.pendingRequests.clear(),this.resetStats()}}function t(t){return new e(t)}const s=new e;export{e as DeduplicationManager,t as createDeduplicationManager,s as globalDeduplicationManager};\n//# sourceMappingURL=dedup-manager.js.map\n"],"names":["e","t","s"],"mappings":"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"}