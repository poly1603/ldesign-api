{"version":3,"file":"cache.cjs","sources":["../../../../../http/es/utils/cache.js"],"sourcesContent":["class e{constructor(e=1e3){this.cache=new Map,this.accessOrder=new Map,this.maxSize=1e3,this.cleanupInterval=6e4,this.isDestroyed=!1,this.maxSize=e,this.startCleanup()}async get(e){const t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),this.accessOrder.delete(e),null):(this.accessOrder.set(e,Date.now()),t.data):null}async set(e,t,s=3e5){this.cache.size>=this.maxSize&&this.evictLRU(),this.cache.set(e,{data:t,timestamp:Date.now(),ttl:s}),this.accessOrder.set(e,Date.now())}async delete(e){this.cache.delete(e),this.accessOrder.delete(e)}async clear(){this.cache.clear(),this.accessOrder.clear()}startCleanup(){this.isDestroyed||(this.cleanupTimer=setInterval(()=>{this.isDestroyed||this.cleanupExpired()},this.cleanupInterval),this.cleanupTimer.unref&&this.cleanupTimer.unref())}cleanupExpired(){if(this.isDestroyed)return;const e=Date.now(),t=[];let s=0;for(const[a,i]of this.cache.entries())if(e-i.timestamp>i.ttl&&(t.push(a),s++,s>=100))break;for(const e of t)this.cache.delete(e),this.accessOrder.delete(e)}evictLRU(){if(0===this.accessOrder.size)return;let e=null,t=1/0;for(const[s,a]of this.accessOrder.entries())a<t&&(t=a,e=s);e&&(this.cache.delete(e),this.accessOrder.delete(e))}size(){return this.cache.size}keys(){return Array.from(this.cache.keys())}destroy(){this.isDestroyed=!0,this.cleanupTimer&&(clearInterval(this.cleanupTimer),this.cleanupTimer=void 0),this.cache.clear(),this.accessOrder.clear()}}class t{constructor(e=\"http_cache_\"){this.prefix=e}async get(e){if(typeof localStorage>\"u\")return null;try{const t=localStorage.getItem(this.prefix+e);if(!t)return null;const s=JSON.parse(t);return Date.now()-s.timestamp>s.ttl?(this.delete(e),null):s.data}catch{return null}}async set(e,t,s=3e5){if(!(typeof localStorage>\"u\"))try{const a={data:t,timestamp:Date.now(),ttl:s};localStorage.setItem(this.prefix+e,JSON.stringify(a))}catch{}}async delete(e){typeof localStorage>\"u\"||localStorage.removeItem(this.prefix+e)}async clear(){typeof localStorage>\"u\"||Object.keys(localStorage).forEach(e=>{e.startsWith(this.prefix)&&localStorage.removeItem(e)})}}class s{constructor(t={}){this.keyCache=new Map,this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.config={enabled:t.enabled??!0,ttl:t.ttl??3e5,keyGenerator:t.keyGenerator??this.defaultKeyGenerator,storage:t.storage??new e},this.storage=this.config?.storage}async get(e){if(!this.config?.enabled)return null;const t=this.getCachedKey(e),s=await this.storage.get(t);s?this.stats.hits++:this.stats.misses++;const a=this.stats.hits+this.stats.misses;return this.stats.hitRate=a>0?this.stats.hits/a:0,s}async set(e,t){if(!this.config?.enabled||\"GET\"!==e.method||t.status<200||t.status>=300)return;const s=this.getCachedKey(e);await this.storage.set(s,t,this.config?.ttl)}async delete(e){const t=this.getCachedKey(e);await this.storage.delete(t)}async clear(){await this.storage.clear()}updateConfig(e){Object.assign(this.config,e),e.storage&&(this.storage=e.storage)}getConfig(){return{...this.config}}getStats(){return{...this.stats}}getCachedKey(e){const t=`${e.method||\"GET\"}:${e.url||\"\"}:${e.params?this.fastStringify(e.params):\"\"}:${e.data?this.fastStringify(e.data):\"\"}`;if(this.keyCache.has(t))return this.keyCache.get(t);const s=this.config?.keyGenerator(e);if(this.keyCache.size>1e3){const e=this.keyCache.keys().next().value;void 0!==e&&this.keyCache.delete(e)}return this.keyCache.set(t,s),s}fastStringify(e){return null==e?\"\":\"string\"==typeof e?e:\"number\"==typeof e||\"boolean\"==typeof e?String(e):JSON.stringify(e)}defaultKeyGenerator(e){const{method:t=\"GET\",url:s=\"\",params:a={},data:i}=e;let r=`${t}:${s}`;const n=Object.keys(a).sort();if(n.length>0){r+=`?${n.map(e=>`${e}=${a[e]}`).join(\"&\")}`}if(i&&\"GET\"!==t){r+=`:${function(e){let t=0;for(let s=0;s<e.length;s++){t=(t<<5)-t+e.charCodeAt(s),t&=t}return Math.abs(t).toString(36)}(\"string\"==typeof i?i:JSON.stringify(i))}`}return r}}class a extends s{constructor(e={}){super(e),this.accessLog=new Map,this.tagIndex=new Map,this.dependencyGraph=new Map,this.enhancedConfig={strategy:\"lru\",maxSize:52428800,compression:!1,stats:!0,...e}}async get(e){if(!this.enhancedConfig.stats){if(!this.config?.enabled)return null;const t=this.getCachedKey(e);return await this.storage.get(t)}const t=await super.get(e);if(t){const t=this.getCachedKey(e);this.updateAccessLog(t),this.updateRecentKeys(t)}return t}async set(e,t,s){if(await super.set(e,t),this.enhancedConfig.stats){const t=this.getCachedKey(e);s?.tags&&this.updateTagIndex(t,s.tags),s?.dependencies&&this.updateDependencyGraph(t,s.dependencies),this.updateStats()}}async invalidateByTag(e){const t=this.tagIndex.get(e);if(!t)return 0;const s=t.size;return this.storage.deleteBatch?await this.storage.deleteBatch(Array.from(t)):await Promise.all(Array.from(t).map(e=>this.storage.delete(e))),this.tagIndex.delete(e),this.updateStats(),s}async invalidateByDependency(e){const t=this.dependencyGraph.get(e);if(!t)return 0;let s=0;for(const e of t)await this.storage.delete(e),s++;return this.dependencyGraph.delete(e),this.updateStats(),s}async preload(e){if(!this.enhancedConfig.preload?.enabled)return;const t=e.map(async e=>{try{const t={url:e,method:\"GET\"},s={data:`preloaded-${e}`,status:200,statusText:\"OK\",headers:{},config:t};await this.set(t,s)}catch(e){}});await Promise.all(t)}getStats(){return{...this.stats}}resetStats(){this.stats={hits:0,misses:0,hitRate:0,size:0,memoryUsage:0,recentKeys:[],hotKeys:[]},this.accessLog.clear()}getHotKeys(e=10){return Array.from(this.accessLog.entries()).map(([e,t])=>({key:e,accessCount:t})).sort((e,t)=>t.accessCount-e.accessCount).slice(0,e)}async cleanup(){return this.updateStats(),0}updateAccessLog(e){const t=this.accessLog.get(e)||0;this.accessLog.set(e,t+1)}updateRecentKeys(e){const t=this.stats.recentKeys.indexOf(e);t>-1&&this.stats.recentKeys.splice(t,1),this.stats.recentKeys.unshift(e),this.stats.recentKeys.length>10&&(this.stats.recentKeys=this.stats.recentKeys.slice(0,10))}updateTagIndex(e,t){for(const s of t)this.tagIndex.has(s)||this.tagIndex.set(s,new Set),this.tagIndex.get(s).add(e)}updateDependencyGraph(e,t){for(const s of t)this.dependencyGraph.has(s)||this.dependencyGraph.set(s,new Set),this.dependencyGraph.get(s).add(e)}updateStats(){this.stats.hotKeys=this.getHotKeys()}}function i(e){return new s(e)}function r(e){return new a(e)}function n(){return new e}function c(e){return new t(e)}export{s as CacheManager,a as EnhancedCacheManager,t as LocalStorageCacheStorage,e as MemoryCacheStorage,i as createCacheManager,r as createEnhancedCacheManager,c as createLocalStorage,n as createMemoryStorage};\n//# sourceMappingURL=cache.js.map\n"],"names":["e","t","s","a","i","r","n"],"mappings":";;;;;;;;;;;AAAA,MAAM,CAAA,CAAC;AAAA,EAAC,WAAA,CAAYA,KAAE,GAAA,EAAI;AAAC,IAAA,IAAA,CAAK,KAAA,uBAAU,GAAA,EAAA,EAAI,IAAA,CAAK,8BAAY,IAAI,GAAA,EAAA,EAAI,KAAK,OAAA,GAAQ,GAAA,EAAI,KAAK,eAAA,GAAgB,GAAA,EAAI,KAAK,WAAA,GAAY,KAAA,EAAG,KAAK,OAAA,GAAQA,EAAAA,EAAE,KAAK,YAAA,EAAa;AAAA,EAAC;AAAA,EAAC,MAAM,IAAIA,EAAAA,EAAE;AAAC,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,KAAA,CAAM,GAAA,CAAID,EAAC,CAAA;AAAE,IAAA,OAAOC,EAAAA,GAAE,IAAA,CAAK,GAAA,EAAI,GAAEA,EAAAA,CAAE,SAAA,GAAUA,EAAAA,CAAE,GAAA,IAAK,IAAA,CAAK,KAAA,CAAM,MAAA,CAAOD,EAAC,CAAA,EAAE,IAAA,CAAK,WAAA,CAAY,MAAA,CAAOA,EAAC,CAAA,EAAE,IAAA,KAAO,IAAA,CAAK,WAAA,CAAY,GAAA,CAAIA,EAAAA,EAAE,IAAA,CAAK,GAAA,EAAK,CAAA,EAAEC,EAAAA,CAAE,IAAA,CAAA,GAAM,IAAA;AAAA,EAAI;AAAA,EAAC,MAAM,GAAA,CAAID,EAAAA,EAAEC,EAAAA,EAAEC,KAAE,GAAA,EAAI;AAAC,IAAA,IAAA,CAAK,KAAA,CAAM,IAAA,IAAM,IAAA,CAAK,OAAA,IAAS,IAAA,CAAK,QAAA,EAAS,EAAE,IAAA,CAAK,KAAA,CAAM,GAAA,CAAIF,EAAAA,EAAE,EAAC,IAAA,EAAKC,EAAAA,EAAE,SAAA,EAAU,IAAA,CAAK,GAAA,EAAI,EAAE,GAAA,EAAIC,EAAAA,EAAE,CAAA,EAAE,IAAA,CAAK,WAAA,CAAY,GAAA,CAAIF,EAAAA,EAAE,IAAA,CAAK,GAAA,EAAK,CAAA;AAAA,EAAC;AAAA,EAAC,MAAM,OAAOA,EAAAA,EAAE;AAAC,IAAA,IAAA,CAAK,MAAM,MAAA,CAAOA,EAAC,GAAE,IAAA,CAAK,WAAA,CAAY,OAAOA,EAAC,CAAA;AAAA,EAAC;AAAA,EAAC,MAAM,KAAA,GAAO;AAAC,IAAA,IAAA,CAAK,KAAA,CAAM,KAAA,EAAM,EAAE,IAAA,CAAK,YAAY,KAAA,EAAM;AAAA,EAAC;AAAA,EAAC,YAAA,GAAc;AAAC,IAAA,IAAA,CAAK,WAAA,KAAc,IAAA,CAAK,YAAA,GAAa,WAAA,CAAY,MAAI;AAAC,MAAA,IAAA,CAAK,WAAA,IAAa,KAAK,cAAA,EAAe;AAAA,IAAC,CAAA,EAAE,KAAK,eAAe,CAAA,EAAE,KAAK,YAAA,CAAa,KAAA,IAAO,IAAA,CAAK,YAAA,CAAa,KAAA,EAAM,CAAA;AAAA,EAAE;AAAA,EAAC,cAAA,GAAgB;AAAC,IAAA,IAAG,KAAK,WAAA,EAAY;AAAO,IAAA,MAAMA,EAAAA,GAAE,IAAA,CAAK,GAAA,EAAI,EAAEC,KAAE,EAAC;AAAE,IAAA,IAAIC,EAAAA,GAAE,CAAA;AAAE,IAAA,KAAA,MAAS,CAACC,IAAEC,EAAC,CAAA,IAAI,KAAK,KAAA,CAAM,OAAA,IAAU,IAAGJ,EAAAA,GAAEI,GAAE,SAAA,GAAUA,EAAAA,CAAE,QAAMH,EAAAA,CAAE,IAAA,CAAKE,EAAC,CAAA,EAAED,EAAAA,EAAAA,EAAIA,MAAG,GAAA,CAAA,EAAK;AAAM,IAAA,KAAA,MAAUF,EAAAA,IAAKC,EAAAA,EAAE,IAAA,CAAK,KAAA,CAAM,MAAA,CAAOD,EAAC,CAAA,EAAE,IAAA,CAAK,WAAA,CAAY,MAAA,CAAOA,EAAC,CAAA;AAAA,EAAC;AAAA,EAAC,QAAA,GAAU;AAAC,IAAA,IAAG,CAAA,KAAI,IAAA,CAAK,WAAA,CAAY,IAAA,EAAK;AAAO,IAAA,IAAIA,EAAAA,GAAE,IAAA,EAAKC,EAAAA,GAAE,CAAA,GAAE,CAAA;AAAE,IAAA,KAAA,MAAS,CAACC,EAAAA,EAAEC,EAAC,CAAA,IAAI,IAAA,CAAK,WAAA,CAAY,OAAA,EAAQ,EAAEA,EAAAA,GAAEF,EAAAA,KAAIA,EAAAA,GAAEE,IAAEH,EAAAA,GAAEE,EAAAA,CAAAA;AAAG,IAAAF,EAAAA,KAAI,KAAK,KAAA,CAAM,MAAA,CAAOA,EAAC,CAAA,EAAE,IAAA,CAAK,WAAA,CAAY,MAAA,CAAOA,EAAC,CAAA,CAAA;AAAA,EAAE;AAAA,EAAC,IAAA,GAAM;AAAC,IAAA,OAAO,KAAK,KAAA,CAAM,IAAA;AAAA,EAAI;AAAA,EAAC,IAAA,GAAM;AAAC,IAAA,OAAO,KAAA,CAAM,IAAA,CAAK,IAAA,CAAK,KAAA,CAAM,MAAM,CAAA;AAAA,EAAC;AAAA,EAAC,OAAA,GAAS;AAAC,IAAA,IAAA,CAAK,cAAY,IAAA,EAAG,IAAA,CAAK,YAAA,KAAe,aAAA,CAAc,KAAK,YAAY,CAAA,EAAE,IAAA,CAAK,YAAA,GAAa,SAAQ,IAAA,CAAK,KAAA,CAAM,OAAM,EAAE,IAAA,CAAK,YAAY,KAAA,EAAM;AAAA,EAAC;AAAC;AAA2oB,MAAM,CAAA,CAAC;AAAA,EAAC,WAAA,CAAYC,EAAAA,GAAE,EAAC,EAAE;AAAC,IAAA,IAAA,CAAK,QAAA,uBAAa,GAAA,EAAA,EAAI,IAAA,CAAK,QAAM,EAAC,IAAA,EAAK,CAAA,EAAE,MAAA,EAAO,CAAA,EAAE,OAAA,EAAQ,GAAE,IAAA,EAAK,CAAA,EAAE,aAAY,CAAA,EAAE,UAAA,EAAW,EAAC,EAAE,OAAA,EAAQ,EAAC,EAAC,EAAE,IAAA,CAAK,SAAO,EAAC,OAAA,EAAQA,GAAE,OAAA,IAAS,IAAA,EAAG,KAAIA,EAAAA,CAAE,GAAA,IAAK,GAAA,EAAI,YAAA,EAAaA,EAAAA,CAAE,YAAA,IAAc,KAAK,mBAAA,EAAoB,OAAA,EAAQA,GAAE,OAAA,IAAS,IAAI,KAAC,EAAE,IAAA,CAAK,OAAA,GAAQ,IAAA,CAAK,MAAA,EAAQ,OAAA;AAAA,EAAO;AAAA,EAAC,MAAM,IAAID,EAAAA,EAAE;AAAC,IAAA,IAAG,CAAC,IAAA,CAAK,MAAA,EAAQ,OAAA,EAAQ,OAAO,IAAA;AAAK,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,YAAA,CAAaD,EAAC,CAAA,EAAEE,KAAE,MAAM,IAAA,CAAK,OAAA,CAAQ,GAAA,CAAID,EAAC,CAAA;AAAE,IAAAC,EAAAA,GAAE,IAAA,CAAK,KAAA,CAAM,IAAA,EAAA,GAAO,KAAK,KAAA,CAAM,MAAA,EAAA;AAAS,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,KAAA,CAAM,IAAA,GAAK,KAAK,KAAA,CAAM,MAAA;AAAO,IAAA,OAAO,IAAA,CAAK,MAAM,OAAA,GAAQA,EAAAA,GAAE,IAAE,IAAA,CAAK,KAAA,CAAM,IAAA,GAAKA,EAAAA,GAAE,CAAA,EAAED,EAAAA;AAAA,EAAC;AAAA,EAAC,MAAM,GAAA,CAAIF,EAAAA,EAAEC,EAAAA,EAAE;AAAC,IAAA,IAAG,CAAC,IAAA,CAAK,MAAA,EAAQ,OAAA,IAAS,KAAA,KAAQD,EAAAA,CAAE,MAAA,IAAQC,EAAAA,CAAE,MAAA,GAAO,GAAA,IAAKA,EAAAA,CAAE,MAAA,IAAQ,GAAA,EAAI;AAAO,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,YAAA,CAAaF,EAAC,CAAA;AAAE,IAAA,MAAM,KAAK,OAAA,CAAQ,GAAA,CAAIE,IAAED,EAAAA,EAAE,IAAA,CAAK,QAAQ,GAAG,CAAA;AAAA,EAAC;AAAA,EAAC,MAAM,OAAOD,EAAAA,EAAE;AAAC,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,YAAA,CAAaD,EAAC,CAAA;AAAE,IAAA,MAAM,IAAA,CAAK,OAAA,CAAQ,MAAA,CAAOC,EAAC,CAAA;AAAA,EAAC;AAAA,EAAC,MAAM,KAAA,GAAO;AAAC,IAAA,MAAM,IAAA,CAAK,QAAQ,KAAA,EAAM;AAAA,EAAC;AAAA,EAAC,aAAaD,EAAAA,EAAE;AAAC,IAAA,MAAA,CAAO,MAAA,CAAO,KAAK,MAAA,EAAOA,EAAC,GAAEA,EAAAA,CAAE,OAAA,KAAU,IAAA,CAAK,OAAA,GAAQA,EAAAA,CAAE,OAAA,CAAA;AAAA,EAAQ;AAAA,EAAC,SAAA,GAAW;AAAC,IAAA,OAAM,EAAC,GAAG,IAAA,CAAK,MAAA,EAAM;AAAA,EAAC;AAAA,EAAC,QAAA,GAAU;AAAC,IAAA,OAAM,EAAC,GAAG,IAAA,CAAK,KAAA,EAAK;AAAA,EAAC;AAAA,EAAC,aAAaA,EAAAA,EAAE;AAAC,IAAA,MAAMC,EAAAA,GAAE,CAAA,EAAGD,EAAAA,CAAE,MAAA,IAAQ,KAAK,CAAA,CAAA,EAAIA,EAAAA,CAAE,GAAA,IAAK,EAAE,CAAA,CAAA,EAAIA,EAAAA,CAAE,MAAA,GAAO,IAAA,CAAK,cAAcA,EAAAA,CAAE,MAAM,CAAA,GAAE,EAAE,CAAA,CAAA,EAAIA,EAAAA,CAAE,IAAA,GAAK,IAAA,CAAK,aAAA,CAAcA,EAAAA,CAAE,IAAI,CAAA,GAAE,EAAE,CAAA,CAAA;AAAG,IAAA,IAAG,IAAA,CAAK,SAAS,GAAA,CAAIC,EAAC,GAAE,OAAO,IAAA,CAAK,QAAA,CAAS,GAAA,CAAIA,EAAC,CAAA;AAAE,IAAA,MAAMC,EAAAA,GAAE,IAAA,CAAK,MAAA,EAAQ,YAAA,CAAaF,EAAC,CAAA;AAAE,IAAA,IAAG,IAAA,CAAK,QAAA,CAAS,IAAA,GAAK,GAAA,EAAI;AAAC,MAAA,MAAMA,KAAE,IAAA,CAAK,QAAA,CAAS,IAAA,EAAK,CAAE,MAAK,CAAE,KAAA;AAAM,MAAA,MAAA,KAASA,EAAAA,IAAG,IAAA,CAAK,QAAA,CAAS,MAAA,CAAOA,EAAC,CAAA;AAAA,IAAC;AAAC,IAAA,OAAO,IAAA,CAAK,QAAA,CAAS,GAAA,CAAIC,EAAAA,EAAEC,EAAC,CAAA,EAAEA,EAAAA;AAAA,EAAC;AAAA,EAAC,cAAcF,EAAAA,EAAE;AAAC,IAAA,OAAO,QAAMA,EAAAA,GAAE,EAAA,GAAG,YAAU,OAAOA,EAAAA,GAAEA,KAAE,QAAA,IAAU,OAAOA,EAAAA,IAAG,SAAA,IAAW,OAAOA,EAAAA,GAAE,MAAA,CAAOA,EAAC,CAAA,GAAE,IAAA,CAAK,UAAUA,EAAC,CAAA;AAAA,EAAC;AAAA,EAAC,oBAAoBA,EAAAA,EAAE;AAAC,IAAA,MAAK,EAAC,MAAA,EAAOC,EAAAA,GAAE,KAAA,EAAM,GAAA,EAAIC,EAAAA,GAAE,EAAA,EAAG,MAAA,EAAOC,EAAAA,GAAE,EAAC,EAAE,IAAA,EAAKC,IAAC,GAAEJ,EAAAA;AAAE,IAAA,IAAIK,EAAAA,GAAE,CAAA,EAAGJ,EAAC,CAAA,CAAA,EAAIC,EAAC,CAAA,CAAA;AAAG,IAAA,MAAMI,EAAAA,GAAE,MAAA,CAAO,IAAA,CAAKH,EAAC,EAAE,IAAA,EAAK;AAAE,IAAA,IAAGG,EAAAA,CAAE,SAAO,CAAA,EAAE;AAAC,MAAAD,MAAG,CAAA,CAAA,EAAIC,EAAAA,CAAE,GAAA,CAAI,CAAAN,OAAG,CAAA,EAAGA,EAAC,CAAA,CAAA,EAAIG,EAAAA,CAAEH,EAAC,CAAC,CAAA,CAAE,CAAA,CAAE,IAAA,CAAK,GAAG,CAAC,CAAA,CAAA;AAAA,IAAE;AAAC,IAAA,IAAGI,EAAAA,IAAG,UAAQH,EAAAA,EAAE;AAAC,MAAAI,EAAAA,IAAG,CAAA,CAAA,EAAA,CAAI,SAASL,EAAAA,EAAE;AAAC,QAAA,IAAIC,EAAAA,GAAE,CAAA;AAAE,QAAA,KAAA,IAAQC,EAAAA,GAAE,CAAA,EAAEA,EAAAA,GAAEF,EAAAA,CAAE,QAAOE,EAAAA,EAAAA,EAAI;AAAC,UAAAD,EAAAA,GAAAA,CAAGA,MAAG,CAAA,IAAGA,EAAAA,GAAED,GAAE,UAAA,CAAWE,EAAC,GAAED,EAAAA,IAAGA,EAAAA;AAAA,QAAC;AAAC,QAAA,OAAO,IAAA,CAAK,GAAA,CAAIA,EAAC,CAAA,CAAE,SAAS,EAAE,CAAA;AAAA,MAAC,CAAA,EAAE,YAAU,OAAOG,EAAAA,GAAEA,KAAE,IAAA,CAAK,SAAA,CAAUA,EAAC,CAAC,CAAC,CAAA,CAAA;AAAA,IAAE;AAAC,IAAA,OAAOC,EAAAA;AAAA,EAAC;AAAC;;;;;;;;"}